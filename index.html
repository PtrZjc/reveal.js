<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Concurrency</title>

	<!-- system required: -->
	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">

	<!-- actual stylesheet -->
	<link rel="stylesheet" href="dist/theme/blood.css">

	<!-- my custom styles  -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css">
	<link rel="stylesheet" href="global.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<em><small>Unlocking the Zoo: A Safari Through Java Concurrency</small></em>
				<h1 class="r-fit-text">Concurrency workshop</h2>
					<p style="text-align: right;">Piotr Zajac</p>
			</section>
			<!-- <section> -->
			<section data-background="media/introducing-threads.png">
				<h2 class="r-fit-text">Some Terminology</h2>
			</section>
			<!-- Terminology -->
			<section>
				<div class="text-2xl text-left">
					<img src="media/d2plots/1_process_model.svg">
					<div class="relative">
						<div class="flex absolute fragment fade-out">
							<div class="w-1/2">
								<p><strong>Concurrency</strong></p>
								<ul>
									<li>Execution of multiple threads and processes simultaneously</li>
								</ul>
								<p><strong>Process</strong></p>
								<ul>
									<li>Group of associated threads</li>
									<li>Execute in shared environment</li>
								</ul>
							</div>
							<div class="w-1/2">
								<p><strong>Thread</strong></p>
								<ul>
									<li>Smallest unit of execution</li>
								</ul>
								<p><strong>Task</strong></p>
								<ul>
									<li>Single unit of work performed by a thread</li>
									<li>Often implemented as lambda expressions</li>
								</ul>
							</div>
						</div>
						<div class="flex absolute fragment fade-in">
							<div class="w-1/2">
								<p><strong>Shared Environment</strong></p>
								<ul>
									<li>Threads in same process share memory space</li>
									<li>Direct communication between threads</li>
								</ul>
							</div>
							<div class="w-1/2">
								<p><strong>Shared Memory</strong></p>
								<ul>
									<li>Includes static variables, instance and local variables</li>
									<li>Enables direct communication between threads</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</section>

			<section>
				<div class="text-2xl text-left -mt-40">
					<div class="align-top">
						<img src="media/round-robin-negate.png">
					</div>
					<div class="flex">
						<div class="w-1/2">
							<p><strong>Thread Scheduler</strong></p>
							<ul>
								<li>Determines which threads to execute</li>
								<li>May use strategies like round-robin scheduling</li>
							</ul>
							<p><strong>Context Switch</strong></p>
							<ul>
								<li>Stores and restores thread's state for later execution</li>
								<li>Associated with a performance cost</li>
							</ul>
						</div>
						<div class="w-1/2">
							<p><strong>Optimised Thread Scheduling</strong></p>
							<ul>
								<li>Goal to minimize context switches</li>
								<li>Maintains smooth application running</li>
							</ul>
							<p><strong>Thread Priority</strong></p>
							<ul>
								<li>Numeric value associated with each thread</li>
								<li>Used by scheduler to determine execution order</li>
								<li>In Java, specified as integer values</li>
							</ul>
						</div>
					</div>
				</div>
			</section>

			<section data-background="media/introducing-threads.png">
				<h2 class="r-fit-text">Introducing Threads!</h2>
			</section>

			<section data-auto-animate>
				<h6>Creating a Thread</h6>
				<div class="text-left text-2xl">
					<p><strong>To create a Thread in Java:</strong></p>
					<ul>
						<div data-id="text">
							<li>Create a class that extends <code>Thread</code> and overrides the <code>run()</code> method</li>
						</div>
						<div>
							<li>Provide a <code>Runnable</code> object or lambda expression to the <code>Thread</code> constructor.
							</li>
						</div>
						</li>
						<li>Use Concurrency API</li>
					</ul>
				</div>
				<div class="">
					<pre data-id="code" class="language-java"><code data-trim>
					@FunctionalInterface
					public interface Runnable { 
					  	void run();
					}
					</code></pre>
				</div>
			</section>

			<section data-auto-animate>
				<div class="text-2xl" data-id="text">
					<ul>
						<li>Create a class that extends <code>Thread</code> and overrides the <code>run()</code> method</li>
					</ul>
				</div>
				<pre data-id="code"><code class="language-java" data-trim >
					public class AnimalCounter extends Thread {
						@Override
						public void run() {
							System.out.println("Counting all the animals in the zoo");
						}
					}
					</code></pre>
				<div class="text-4xl">
					<i class="fragment fade-in">Who even does that?</i>
				</div>
			</section>

			<section data-auto-animate>
				<div class="text-2xl" data-id="text">
					<ul>
						<li>Provide a <code>Runnable</code> object or lambda expression to the <code>Thread</code>
							constructor. </li>
					</ul>
				</div>
				<pre data-id="code"><code class="language-java" data-trim >

						new Thread(() -> System.out.print("Counting")).start();

					</code></pre>
				<div class="text-4xl">
				</div>
			</section>

			<section data-auto-animate>
				<div data-id="text" class="text-3xl">Let's work a bit!</div>
				<pre data-id="code"><code class="language-java" data-trim >
				Runnable countAnimals = () -> 
					System.out.println("Counting all the animals in the zoo"); 
				
				Runnable printAnimalProfiles = () -> 
					IntStream.rangeClosed(1, 3).forEach(i -> 
						System.out.println("Printing profile of animal " + i)
					);
					</code></pre>
			</section>

			<section data-auto-animate>
				<div data-id="text" class="text-3xl">Let's work a bit!</div>
				<pre data-id="code"><code class="language-java" data-trim ="8-13">
				Runnable countAnimals = () -> 
					System.out.println("Counting all the animals in the zoo"); 
					
				Runnable printAnimalProfiles = () -> 
					IntStream.rangeClosed(1, 3).forEach(i -> 
						System.out.println("Printing profile of animal " + i)
					);

				System.out.println("Zoo day begins");  
				new Thread(countAnimals).start(); 
				new Thread(printAnimalProfiles).start(); 
				new Thread(countAnimals).start(); 
				System.out.println("Zoo day ends");
					</code></pre>
				<div class="text-3xl fragment fade-in">Overtime?</div>
			</section>

			<section>
				<div class="text-2xl">
					<ul>
						<li>Use Concurrency API</li>
					</ul>
					<p class="fragment fade-in italic">later!</p>
				</div>
			</section>

			<!-- Thread Types -->
			<section>
				<h4>There are more Threads!</h2>
			</section>

			<section>
				<h6>Thread Types</h2>
					<div class="flex text-2xl text-left">
						<div class="w-1/3">
							<p><strong>System Threads</strong></p>
							<ul>
								<li>Created by JVM</li>
								<li>Run in background</li>
								<li>Example: Garbage collection</li>
							</ul>
						</div>
						<div class="w-1/3">
							<p><strong>User-Defined Threads</strong></p>
							<ul>
								<li>Created by developers</li>
								<li>Specific tasks</li>
								<li>Example: `main()` method thread</li>
							</ul>
						</div>
						<div class="w-1/3">
							<p><strong>Daemon Threads</strong></p>
							<ul>
								<li>JVM exits if only daemon threads are running</li>
								<li>Example: Garbage collection</li>
							</ul>
						</div>
					</div>
			</section>

			<section data-auto-animate>
				<pre data-id="code"><code class="language-java" data-trim data-line-numbers>
								public class Zookeper {
									public static void main(String[] unused) {
										var feedingJob = new Thread(Zookeper::feedAnimals);
										feedingJob.start();
										System.out.println("Zoo is closing");
									}
							
									@SneakyThrows
									private static void feedAnimals() {
										Thread.sleep(3_000);
										System.out.println("All animals fed!");
									}
								}
								</code></pre>
			</section>

			<section data-auto-animate>
				<pre data-id="code"><code class="language-java" data-trim data-line-numbers>
								public class EvilZookeper {
									public static void main(String[] unused) {
										var feedingJob = new Thread(Zookeper::feedAnimals);
										feedingJob.setDaemon(true);
										feedingJob.start();
										System.out.println("Zoo is closing");
									}
							
									@SneakyThrows
									private static void feedAnimals() {
										Thread.sleep(3_000);
										System.out.println("All animals fed!");
									}
								}
								</code></pre>
			</section>

			<!-- Managing a Thread’s Life Cycle -->
			<section>
				<h3>Thread’s Life Cycle</h3>
			</section>

			<section>
				<!-- <div class="flex text-2xl text-left"> -->
				<div class="text-left">
					<p>State <code>enum</code> in <code>java.lang.Thread</code>:</p>
					<ul>
						<li><code>NEW</code></li>
						<li><code>RUNNABLE</code></li>
						<li><code>BLOCKED</code></li>
						<li><code>WAITING</code></li>
						<li><code>TIMED_WAITING</code></li>
						<li><code>TERMINATED</code></li>
					</ul>
				</div>
			</section>

			<section>
				<div class="-mx-40 -my-10">
					<img src="./media/d2plots/2_thread_states.svg" class="r-stretch" />
				</div>
			</section>


			<section>
				<h4>Let's wait for million visitors now!</h4>
			</section>

			<section>
				<h4>Concurrency API</h4>
			</section>

			<section>
				ExecutorService
				- java.util.concurrent interface for managing and scheduling the execution of tasks in a thread pool.
			</section>

			<section>
				<div class="-mx-40 -my-10">
					<img src="./media/d2plots/3_ExecutorService_file_cycle.svg" class="r-stretch" />
				</div>
			</section>

			<section>
				<h4>Concurrency API</h4>
			</section>

			<section>
				<div class="text-2xl text-left">
					<ul>
						<li><strong>Thread Pool:</strong> A collection of pre-initialized threads, reusable for executing tasks.
							Improves performance by reducing the overhead of thread creation and destruction.</li>
						<li><strong>ExecutorService:</strong> An interface for managing a thread pool. Provides methods for task
							scheduling and lifecycle management, like graceful shutdown.</li>
						<li><strong>Executors:</strong> Utility class in Java that provides factory methods for creating different
							types of Executor Services, such as single-threaded, fixed-size, and cached thread pools.</li>
					</ul>
					Executor Service manages a Thread Pool, and Executors make it easy to create and configure an Executor Service
				</div>
			</section>

			<!-- https://www.baeldung.com/thread-pool-java-and-guava -->

			<section data-auto-animate>
				<div class="text-3xl" data-id="text">Let's rewrite earlier example</div>
				<pre><code data-id="code" class="language-java" data-trim="">
						Runnable countAnimals = () -> {}; //omitted
						Runnable printAnimalProfiles = () -> {}; //omitted

						ExecutorService service = Executors.newSingleThreadExecutor()
						try {
							  System.out.println("Zoo day begins");
							  service.execute(countAnimals);
							  service.execute(printAnimalProfiles);
							  service.execute(countAnimals);
							  System.out.println("Zoo day ends");
						} finally {
							  service.shutdown();
						}
					</code></pre>
				<!-- Once you have finished using a thread executor, it is important that you call the shutdown() method. 
					A thread executor creates a non-daemon thread on the first task that is executed, so failing to call 
					shutdown() will result in your application never terminating. -->
			</section>
			</section>


			<section data-auto-animate>
				<div class="text-3xl" data-id="text">Or use try-with-resources</div>
				<pre><code data-id="code" class="language-java" data-trim="">
					Runnable countAnimals = () -> {}; //omitted
					Runnable printAnimalProfiles = () -> {}; //omitted

					try (ExecutorService service = 
											Executors.newSingleThreadExecutor()) {
						  System.out.println("Zoo day begins");
						  service.execute(countAnimals);
						  service.execute(printAnimalProfiles);
						  service.execute(countAnimals);
						  System.out.println("Zoo day ends");
					}
					</code></pre>
				<!-- AutoCloseable interface -->
			</section>



			<section>
				<div class="text-4xl font-semibold">ExecutorService life cycle</div>
				<div>
					<img src="./media/d2plots/3_ExecutorService_file_cycle.svg" class="r-stretch" />
				</div>
				<!-- be aware that shutdown() does not stop any tasks that have already been submitted to the thread executor -->
			</section>



			<section>
				<div>
					<div class="text-4xl" data-id="text">Meet the <code>Callable</code></div>
					<pre data-id="code" class="language-java"><code data-trim><script type="text/template">
					@FunctionalInterface
					public interface Callable<V> {
						V call() throws Exception;
					}
				</script></code></pre>
				</div>
			</section>


			<section>
				<div class="text-3xl" data-id="text">Executing tasks with <strong>ExecutorService</strong></div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim="" data-line-numbers="1-6|8-10|12-20"><script type="text/template">

							void execute(Runnable command)
							// Executes Runnable task at some point in future.
							
							Future<?> submit(Runnable task)
							// Executes Runnable task at some point in future 
							// and returns Future representing task.
							
							<T> Future<T> submit(Callable<T> task)
							// Executes Callable task at some point in future 
							// and returns Future representing pending results of task.
							
							<T> List<Future<T>> 
									    invokeAll(Collection<? extends Callable<T>> tasks)
							// Executes given tasks and waits for all tasks to 
							// complete. Returns List of Future instances in same 
							// order in which they were in original collection.
							
							<T> T invokeAny(Collection<? extends Callable<T>> tasks)
							// Executes given tasks and waits for at least one to 
							// complete.

						</script></code></pre>
				</div>
			</section>


			<section>
				<div class="text-3xl" data-id="text">Waiting for <strong>Future</strong> results</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim="" data-line-numbers="1-7|9-12|14-22"><script type="text/template">

						void isDone()
						// Returns true if task was completed, threw an exception, 
						// or was canceled.
						
						boolean isCancelled()
						// Returns true if the task was canceled before it 
						// completed normally.
						
						boolean cancel(boolean mayInterruptIfRunning)
						// Attempts to cancel the execution of the task and returns
						// true if it was successfully canceled or false if it 
						// could not be canceled or is complete.
						
						V get()
						// Retrieves the result of the task, waiting endlessly if 
						// it is not yet available.
						
						V get(long timeout, TimeUnit unit)
						// Retrieves the result of the task, waiting for the 
						// specified amount of time. If the result is not ready by 
						// the time the timeout is reached, a checked 
						// TimeoutException will be thrown.
						
						</script></code></pre>
				</div>
			</section>

			<section>
				<h4>Let's sell some tickets to zoo now!</h4>
			</section>


			<section>
				<h3>Scheduling Tasks</h3>
			</section>

			<section>
				<pre><code class="language-java" data-trim=""><script type="text/template">
					ScheduledExecutorService service
						= Executors.newSingleThreadScheduledExecutor();
				</script></code></pre>
				<div class="text-2xl text-left mx-20">
					<ul class="space-y-2">
						<li>Enables sheduling tasks</li>
						<li>Subinterface of <strong>ExecutorService</strong> </li>
						<li>All method return <strong>ScheduledFuture</strong> </li>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Scheduling tasks with <strong>ScheduledExecutorService</strong></div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="1-7|9-13|15-20"><script type="text/template">

						schedule(Callable<V> callable, long delay, TimeUnit unit)
						// Creates and executes a Callable task after the given 
						// delay.
						
						schedule(Runnable command, long delay, TimeUnit unit)
						// Creates and executes a Runnable task after the given
						// delay.
						
						scheduleAtFixedRate(Runnable command, long initialDelay, 
																long period, TimeUnit unit)
						// Creates and executes a Runnable task after the given 
						// initial delay, creating a new task every period value 
						// that passes.
						
						scheduleWithFixedDelay(Runnable command, long initialDelay, 
																	 long delay, TimeUnit unit)
						// Creates and executes a Runnable task after the given 
						// initial delay and subsequently with the given delay 
						// between the termination of one execution and the 
						// beginning of the next.
						</script></code></pre>
				</div>
				<!-- These methods are among the most convenient in the Concurrency API, as they perform relatively complex tasks with a single line of code. -->

			</section>

			<section>
				<img src="./media/ScheduledExecutorService.jpg" class="r-stretch" />
			</section>

			<section>
				<h4>Okay, but where is concurrency?</h4>
			</section>

			<section>
				<h3>Thread Pools</h3>
			</section>

			<section>
				<div class="text-3xl" data-id="text"><strong>Executors</strong> factory methods</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="|5-8|10-16"><script type="text/template">

						ExecutorService newSingleThreadExecutor()

						ScheduledExecutorService newSingleThreadScheduledExecutor()
						
						ExecutorService newCachedThreadPool()
						// Creates a thread pool that creates new threads as needed
						// but reuses previously constructed threads when they are 
						// available.
						
						ExecutorService newFixedThreadPool(int nThreads)
						// Creates a thread pool that reuses a fixed number of 
						// threads operating off a shared unbounded queue.
						
						ScheduledExecutorService newScheduledThreadPool(
																											int nThreads)
						// Creates a thread pool that can schedule commands to 
						// run after a given delay or execute periodically.
					</script></code></pre>
				</div>
				<!-- there is no hard limit to the number of threads it can spawn; it will keep creating new threads as long as tasks keep getting submitted and existing threads are occupied. However, unused threads will be terminated and removed from the cache if they remain idle for 60 seconds. -->
			</section>

			<section>
				<h2>Thread safety</h2>
			</section>

			<section>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="|2|4-6|8-18"><script type="text/template">
						public class MonkeyKeeper {
							private static int monkeyCount;
					
							private static void incrementAndReport() {
								System.out.print(++monkeyCount + " ");
							}
						
							public static void main(String[] args) {
								try (ExecutorService service =
																	Executors.newFixedThreadPool(10)) {
									IntStream
										.range(0, 10)
										.forEach(i -> service.submit(
																		MonkeyKeeper::incrementAndReport));
								}
							}
						}
					
					</script></code></pre>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">possible outcomes</div>
				<div class="flex justify-center">
					<div class="w-2/5">
						<pre><code data-id="code" class="language-java" data-trim ><script type="text/template">
						1 2 3 4 5 6 7 8 9 10 
						1 8 7 3 2 6 5 4 10 9
						1 9 8 7 3 6 6 2 4 5
					</script></code></pre>
					</div>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">What happened there?</div>
				<div class="flex justify-center">
					<img src="./media/lack-of-synchronization.drawio.svg" class="w-4/6" />
				</div>
			</section>

			<!-- https://www.geeksforgeeks.org/volatile-keyword-in-java/ -->

			<section>
				<div class="space-y-4">
					<div class="text-2xl">Also... </div>
					<div class="text-3xl">Changes made to static <code>monkeyCount</code> in one thread </div>
					<div class="text-3xl">may not immediately be visible to another thread</div>
					<div class="text-3xl fragment fade-in">How to ensure its visibility?</div>
				</div>
			</section>

			<section>
				<div class="text-3xl my-5" data-id="text"><strong>volatile</strong> keyword</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class MonkeyKeeper {
						private volatile static int monkeyCount;
						//...
					}
				</script></code></pre>
				<div class="text-3xl fragment fade-in">This won't work...</div>
				<!-- https://www.geeksforgeeks.org/volatile-keyword-in-java/ -->
			</section>

			<section>
				<div class="text-3xl my-5" data-id="text"><code>volatile</code> provides:</div>
				<div class="flex justify-center">
					<div class="text-2xl text-left w-2/3">
						<div class="">1. <strong>Visibility</strong>: Every read of that field is read directly from the main
							memory.
						</div>
						<div class="">2. <strong>Ordering</strong>: Every write to the field will be written/flushed directly to the
							main memory ("happens-before" relationship)</div>
					</div>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">typical <code>volatile</code> usage</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class SharedResource {
						private volatile boolean flag = false;
				
						public void turnOn() {
								flag = true;
						}
				
						public void checkStatus() {
								if (flag) {
										// Do something...
								}
						}
					}
				</script></code></pre>
				<div class="text-xl">
					<div class="fragment fade-in">One thread is calling the <code>turnOn()</code> method and another thread
						is calling <code>checkStatus()</code>
					</div>
					<div class="fragment fade-in">The second thread is guaranteed to see the updated value of <code>flag</code> if
						it checks after the first thread has called <code>turnOn()</code>.
					</div>
			</section>


			<section>
				<div class="space-y-4">
					<div class="text-2xl">Let's come back to the monkeys</div>
					<div class="text-4xl fragment fade-in">How to fix it?</div>
				</div>
			</section>

			<!--  ATOMIC CLASSES -->
			<section>
				<h3>Atomic classes</h3>
			</section>


			<section>
				<ul class="text-2xl space-y-4">
					<li><strong>Atomic</strong> is the property of an operation to be carried out as a single unit of execution
						without any interference from another thread</li>
					<li>Atomic classes provide a way to perform atomic operations on a single variable without using synchronized
						blocks.</li>
					<li>Part of the <code>java.util.concurrent.atomic</code></li>
				</ul>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Atomic operations</div>
				<div class="flex justify-center">
					<img src="./media/atomic-operation.drawio.svg" class="w-4/6" />
				</div>
			</section>

			<section>
				<pre><code class="language-java" data-trim ><script type="text/template">
					public class MonkeyKeeper {
						private AtomicInteger monkeyCount = new AtomicInteger(0)

						private void incrementAndReport() {
							System.out.print(monkeyCount.incrementAndGet()+" ");
						}
						//...
					}
				</script></code></pre>
			</section>

			<section>
				<div class="text-2xl">Other atomic classes</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					AtomicInteger counter = new AtomicInteger(0);

					AtomicLong counter = new AtomicLong(0L);

					AtomicBoolean flag = new AtomicBoolean(false);
					
					AtomicReference<String> string = new AtomicReference<>("");
	
				</script></code></pre>
				<div class="fragment fade-in">
					<div class="text-xl my-5">+ array versions:</div>
					<pre><code class="language-java" data-trim >
				AtomicIntegerArray, AtomicLongArray, AtomicReferenceArray
				</code></pre>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Common atomic methods</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="1-9|11-22"><script type="text/template">
				get()
				// Retrieves the current value.

				set(type newValue)
				// Sets the given value, 

				getAndSet(type newValue)
				//  sets a new value and returns the old value

				// For numeric classes only:
				incrementAndGet()
				// equivalent to ++value

				getAndIncrement()
				// equivalent to value++

				decrementAndGet()
				// equivalent to --value

				getAndDecrement()
				// equivalent to value--
			</script></code></pre>
				</div>
			</section>


			<!--  LONGADDER -->
			<section>
				<div class="text-5xl font-bold" data-id="text">AtomicLong vs LongAdder</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">LongAdder methods</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim><script type="text/template">
						void add(long x) // Adds the given value.
						
						void decrement() // Equivalent to add(-1).

						void increment() // Equivalent to add(1).

						void reset() // Resets variables maintaining the sum to zero.
						
						long sum() // Returns the current sum.
						
						long sumThenReset()
						// Equivalent in effect to sum() followed by reset().
						
			</script></code></pre>
				</div>
			</section>


			<section>

				<table>
					<thead>
						<tr>
							<th>Criteria</th>
							<th>AtomicLong</th>
							<th>LongAdder</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>Backing up structure</td>
							<td>
								<div class="text-center">long</div>
							</td>
							<td>
								<div class="text-center">Cell[]</div>
							</td>
						</tr>
						<tr class="fragment highlight-red">
							<td>Atomic Operations</td>
							<td>
								<div class="text-center">CAS</div>
							</td>
							<td>
								<div class="text-center">Striping</div>
							</td>
						</tr>
						<tr>
							<td>Memory Footprint</td>
							<td>
								<div class="text-center">⬇</div>
							</td>
							<td>
								<div class="text-center">⬆</div>
							</td>
						</tr>
						<tr>
							<td>Contention</td>
							<td>
								<div class="text-center">⬆</div>
							</td>
							<td>
								<div class="text-center">⬇</div>
							</td>
						</tr>
						<tr>
							<td>Functionalities</td>
							<td>
								<div class="text-center">⬆</div>
							</td>
							<td>
								<div class="text-center">⬇</div>
							</td>
						</tr>
						<tr>
							<td>Consistency</td>
							<td>
								<div class="text-center">Immediate</div>
							</td>
							<td>
								<div class="text-center">Eventual</div>
							</td>
						</tr>
					</tbody>
				</table>
			</section>

			<section>
				<div class="text-4xl font-bold m-6" data-id="text">Compare-and-Swap (CAS)</div>
				<div class="text-2xl -mb-2" data-id="text">Conceptual view how it works:</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					public boolean compareAndSwap(int expectedValue, int newValue) {
						if (currentValue == expectedValue) {
							currentValue = newValue;
							return true;
						}
						return false;
					}
				</script></code></pre>
			</section>

			<section data-auto-animate>
				<div class="text-2xl -m-4" data-id="text">Implementing a counter using CAS:</div>

				<div class="flex justify-center">
					<div class="w-3/4">
						<pre><code class="language-java" data-id="code" data-trim ><script type="text/template">
						int temp = counter;
						int newValue = temp + 1;
					counter = newValue;
						</script></code></pre>
					</div>
				</div>
			</section>


			<section data-auto-animate>
				<div class="text-2xl -m-4" data-id="text">Implementing a counter using CAS:</div>

				<div class="flex justify-center">
					<div class="w-3/4">
						<pre><code class="language-java" data-id="code" data-trim ><script type="text/template">
							do {
								int temp = counter;
								int newValue = temp + 1;
							} while (!compareAndSwap(temp, newValue)); 
							// Keep trying until successful
						</script></code></pre>
					</div>
				</div>
				<div class="text-2xl fragment fade-in">Atomic classes use CAS operations underneath to perform operations</div>
			</section>

			<section>
				<div class="m-4 font-bold">STRIPING</div>
				<div class="text-2xl text-left">
					<ul class="space-y-2">
						<li class="fragment fade-in">Use array of states to distribute the contention to different memory locations
						</li>
						<li class="fragment fade-in">JVM may allocate those states near each other in the heap, resulting in few
							states can reside in the same CPI cache line (64B)</li>
						<li class="fragment fade-in">This results in <em>False Sharing</em> degrading the performance</li>
						<li class="fragment fade-in">Solution is to add a padding between the states (to 64B)</li>
						<li class="fragment fade-in"><code>Cell</code> is effectively a padded <code>AtomicLong</code></li>
						<li class="fragment fade-in">Above implementation is in the abstract class <a
								href="https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/util/concurrent/atomic/Striped64.java">Striped64</a>
						</li>
					</ul>
				</div>
			</section>


			<!--  SYNCHRONIZATION -->
			<section>
				<h3>Synchronization</h3>
			</section>

			<section>
				<div class="flex justify-center text-2xl text-left">
					<ul class="space-y-2 w-5/6">
						<li>The <em>monitor</em> (or lock) is used to synchronize an access</li>
						<li>Each object in Java may act as a monitor and provide a <em>mutual exclusion</em></li>
						<li>It is a property that at most one thread is executing a particular segment of code at a given time.</li>
						<li class="fragment fade-in"><code>wait(), notify(), notifyAll()</code>: These methods, defined in Object,
							allow threads to wait and wake up</li>
					</ul>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Common atomic methods</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class MonkeyKeeper {

						private static final Object cage = new Object(); // monitor
						private static int monkeyCount;

						private void incrementAndReport() {
							synchronized (cage) {
								System.out.print(++monkeyCount + " ");
							}
						}
						//...
					}
				</script></code></pre>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Synchronization on instance methods</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class LionEnclosure {
						private synchronized void ensureSafety() {
							// Ensure all lions are in their cages
						}
					}
				</script></code></pre>
				<div class="text-2xl">equivalent⭥</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					public class LionEnclosure {
						private void ensureSafety() {
							synchronized(this) {
								// Ensure all lions are in their cages
							}
						}
					}
				</script></code></pre>

			</section>

			<section>
				<div class="text-3xl" data-id="text">Synchronization on static methods</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					Class ZooOperations {
						private static synchronized void openGates() {
								// Open all gates in the zoo
						}
					}
				</script></code></pre>
				<div class="text-2xl">equivalent⭥</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					Class ZooOperations {
						private static void openGates() {
							synchronized(ZooOperations.class) {
								// Open all gates in the zoo
							}
						}
					}
				</script></code></pre>

			</section>

			<!-- LOCK FRAMEWORK  -->
			<section>
				<h4>Lock framework</h4>
			</section>

			<section>
				<div class="text-2xl text-left">
					<ul class="space-y-2">
						<li>The <strong>Lock</strong> interface is the answer to limited functionality to the synchronized blocks.
						</li>
						<li>Conceptually is similar to synchronized keyword, but with a lot more bells and whistles.</li>
						<li>A “lock” can be obtained on any object that implements the Lock interface (vs. any Object with
							synchronized)</li>
						</li>
					</ul>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Synchronization on instance methods</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
						Object object = new Object(); 
						synchronized(object) {
							// Protected code
						}
					</script></code></pre>
				<div class="text-2xl">equivalent⭥</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
						Lock lock = new ReentrantLock();
						try {
							lock.lock();
							// Protected code
						} finally {
							lock.unlock();
						}
					</script></code></pre>
			</section>

			<section>
				<div class="text-3xl" data-id="text"><strong>Lock</strong> methods</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers><script type="text/template">
						void lock()
						// Requests lock and blocks until the lock is acquired.
						
						void unlock()
						// Releases the lock.
						
						boolean tryLock()
						// Requests lock and returns immediately. Returns a boolean
						// indicating whether the lock was successfully acquired.
						
						boolean tryLock(long timeout, TimeUnit unit)
						// Requests lock and blocks for the specified time or until
						// the lock is acquired. Returns a boolean indicating 
						// whether the lock was successfully acquired.						
			</script></code></pre>
				</div>
			</section>

			<section>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers><script type="text/template">
						Lock gateLock = new ReentrantLock();		
						if (gateLock.tryLock()) {
							try {
								lock.lock();
								System.out.println("Gate locked, safely 
																		feeding the lions.");
							} finally {
								gateLock.unlock();
							}
						} else {
							System.out.println("Unable to lock the gate, 
																	switching to feeding the ducks.");
						}				
			</script></code></pre>
					<div class="text-3xl fragment fade-in">Can you spot a mistake?</div>
					<div class="m-4 text-2xl fragment fade-in italic">It is critical to release a lock the same number of times it
						was acquired!</div>
				</div>
			</section>

			<section>
				<div class="text-4xl font-bold m-6">ReentrantReadWriteLock</div>
				<div class="text-2xl text-left fragment fade-in">
					<ul class="space-y-2">
						<li>It includes separate locks for reading and writing data</li>
						<li>Useful on data structures where reads are far more common than writes</li>
					</ul>
				</div>
			</section>


			<!--  CyclicBarrier -->
			<section>
				<div class="text-3xl font-bold">It's time to clean up the lions cages</div>
			</section>

			<section>
				<div class="text-4xl font-bold m-6">CyclicBarrier</div>
				<div class="text-2xl text-left fragment fade-in">
					<ul class="space-y-2">
						<li>A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier
							point. </li>
						<li>Useful in programs involving a fixed sized party of threads that must occasionally wait for each other.
						</li>
						<li>The barrier is called cyclic because it can be re-used after the waiting threads are released.</li>
					</ul>
				</div>
			</section>

			<section>
				<div class="text-3xl font-bold m-6">Other synchronization aid classes</div>
				<table class="text-xl">
					<tr>
						<th class="w-1/6">Class</th>
						<th>Description</th>
					</tr>
					<tr>
						<td>
							<div class="font-mono text-2xl">CountDownLatch</div>
						</td>
						<td>Allows one or more threads to wait until a set of operations in other threads complete. Unlike
							<code>CyclicBarrier</code>, it can't be reset.
						</td>
					</tr>
					<tr>
						<td>
							<div class="font-mono text-2xl">Phaser</div>
						</td>
						<td>Similar to <code>CyclicBarrier</code> and <code>CountDownLatch</code> but more flexible. It allows
							dynamic addition and
							removal of threads that require synchronization.</td>
					</tr>
					<tr>
						<td>
							<div class="font-mono text-2xl">Semaphore</div>
						</td>
						<td>Controls access to a shared resource by maintaining a set of permits, allowing or blocking thread access
							based on the availability of these permits.</td>
					</tr>
					<tr>
						<td>
							<div class="font-mono text-2xl">Exchanger</div>
						</td>
						<td>Allows two threads to exchange objects at a synchronization point. Useful in genetic algorithms,
							pipeline designs, etc.</td>
					</tr>
					<tr>
						<td>
							<div class="font-mono text-2xl">ForkJoinPool RecursiveTask/RecursiveAction</div>
						</td>
						<td>Provides a framework for parallel execution and is especially well-suited for divide-and-conquer
							algorithms.</td>
					</tr>
				</table>
			</section>

			<section>
				<h3>Concurrent Collections</h3>
			</section>

			<section>
				<div class="text-2xl">What is the result?</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
						var monkeyCount = new HashMap<String, Integer>();
						monkeyCount.put("long-nosed", 1);
						monkeyCount.put("capuchin", 2);
						for (String monkeyType : monkeyCount.keySet()){
								monkeyCount.remove(monkeyType);
						}
					</script></code></pre>
				<div class="text-2xl fragment fade-in red"><code>ConcurrentModificationException</code></div>

					
			</section>


			<section>
				<table class="text-xl">
					<thead>
						<tr>
							<th>Class name</th>
							<th>Java Collections interfaces</th>
							<th>Sorted?</th>
							<th>Blocking?</th>
						</tr>
					</thead>
					<tbody class="code-row center">
						<tr>
							<td>ConcurrentHashMap</td>
							<td>Map, ConcurrentMap</td>
							<td>✗</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>ConcurrentLinkedQueue</td>
							<td>Queue</td>
							<td>✗</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>ConcurrentSkipListMap</td>
							<td>Map, SortedMap, NavigableMap, ConcurrentMap, ConcurrentNavigableMap</td>
							<td>✓</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>ConcurrentSkipListSet</td>
							<td>Set, SortedSet, NavigableSet</td>
							<td>✓</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>CopyOnWriteArrayList</td>
							<td>List</td>
							<td>✗</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>CopyOnWriteArraySet</td>
							<td>Set</td>
							<td>✗</td>
							<td>✗</td>
						</tr>
						<tr>
							<td>LinkedBlockingQueue</td>
							<td>Queue, BlockingQueue</td>
							<td>✗</td>
							<td>✓</td>
						</tr>
					</tbody>
				</table>
	
			</section>

			<script src="dist/reveal.js"></script>
			<script src="plugin/notes/notes.js"></script>
			<script src="plugin/markdown/markdown.js"></script>
			<script src="plugin/highlight/highlight.js"></script>
			<script>
				// More info about initialization & config:
				// - https://revealjs.com/initialization/
				// - https://revealjs.com/config/
				Reveal.initialize({
					hash: true,

					// Learn about plugins: https://revealjs.com/plugins/
					plugins: [RevealMarkdown, RevealHighlight, RevealNotes],

					margin: 0.15,
					minScale: 0.2,
					maxScale: 2.0
				});
			</script>
</body>

</html>