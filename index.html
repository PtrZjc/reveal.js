<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Concurrency</title>

	<!-- system required: -->
	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">

	<!-- actual stylesheet -->
	<link rel="stylesheet" href="dist/theme/blood.css">

	<!-- my custom styles  -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css">

</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<em><small>Unlocking the Zoo: A Safari Through Java Concurrency</small></em>
				<h1 class="r-fit-text">Concurrency workshop</h2>
					<p style="text-align: right;">Piotr Zajac</p>
			</section>
			<!-- <section> -->
			<section data-background="media/introducing-threads.png">
				<h2 class="r-fit-text">Some Terminology</h2>
			</section>
			<!-- Terminology -->
			<section>
				<div class="text-2xl text-left">
					<img src="media/d2plots/1_process_model.svg">
					<div class="relative">
						<div class="flex absolute fragment fade-out">
							<div class="w-1/2">
								<p><strong>Concurrency</strong></p>
								<ul>
									<li>Execution of multiple threads and processes simultaneously</li>
								</ul>
								<p><strong>Process</strong></p>
								<ul>
									<li>Group of associated threads</li>
									<li>Execute in shared environment</li>
								</ul>
							</div>
							<div class="w-1/2">
								<p><strong>Thread</strong></p>
								<ul>
									<li>Smallest unit of execution</li>
								</ul>
								<p><strong>Task</strong></p>
								<ul>
									<li>Single unit of work performed by a thread</li>
									<li>Often implemented as lambda expressions</li>
								</ul>
							</div>
						</div>
						<div class="flex absolute fragment fade-in">
							<div class="w-1/2">
								<p><strong>Shared Environment</strong></p>
								<ul>
									<li>Threads in same process share memory space</li>
									<li>Direct communication between threads</li>
								</ul>
							</div>
							<div class="w-1/2">
								<p><strong>Shared Memory</strong></p>
								<ul>
									<li>Includes static variables, instance and local variables</li>
									<li>Enables direct communication between threads</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</section>

			<section>
				<div class="text-2xl text-left -mt-40">
					<div class="align-top">
						<img src="media/round-robin-negate.png">
					</div>
					<div class="flex">
						<div class="w-1/2">
							<p><strong>Thread Scheduler</strong></p>
							<ul>
								<li>Determines which threads to execute</li>
								<li>May use strategies like round-robin scheduling</li>
							</ul>
							<p><strong>Context Switch</strong></p>
							<ul>
								<li>Stores and restores thread's state for later execution</li>
								<li>Associated with a performance cost</li>
							</ul>
						</div>
						<div class="w-1/2">
							<p><strong>Optimised Thread Scheduling</strong></p>
							<ul>
								<li>Goal to minimize context switches</li>
								<li>Maintains smooth application running</li>
							</ul>
							<p><strong>Thread Priority</strong></p>
							<ul>
								<li>Numeric value associated with each thread</li>
								<li>Used by scheduler to determine execution order</li>
								<li>In Java, specified as integer values</li>
							</ul>
						</div>
					</div>
				</div>
			</section>

			<section data-background="media/introducing-threads.png">
				<h2 class="r-fit-text">Introducing Threads!</h2>
			</section>

			<section data-auto-animate>
				<h6>Creating a Thread</h6>
				<div class="text-left text-2xl">
					<p><strong>To create a Thread in Java:</strong></p>
					<ul>
						<div data-id="text">
							<li>Create a class that extends <code>Thread</code> and overrides the <code>run()</code> method</li>
						</div>
						<div>
							<li>Provide a <code>Runnable</code> object or lambda expression to the <code>Thread</code> constructor.
							</li>
						</div>
						</li>
						<li>Use Concurrency API</li>
					</ul>
				</div>
				<div class="">
					<pre data-id="code" class="language-java"><code data-trim>
					@FunctionalInterface
					public interface Runnable { 
					  	void run();
					}
					</code></pre>
				</div>
			</section>

			<section data-auto-animate>
				<div class="text-2xl" data-id="text">
					<ul>
						<li>Create a class that extends <code>Thread</code> and overrides the <code>run()</code> method</li>
					</ul>
				</div>
				<pre data-id="code"><code class="language-java" data-trim >
					public class AnimalCounter extends Thread {
						@Override
						public void run() {
							System.out.println("Counting all the animals in the zoo");
						}
					}
					</code></pre>
				<div class="text-4xl">
					<i class="fragment fade-in">Who even does that?</i>
				</div>
			</section>

			<section data-auto-animate>
				<div class="text-2xl" data-id="text">
					<ul>
						<li>Provide a <code>Runnable</code> object or lambda expression to the <code>Thread</code>
							constructor. </li>
					</ul>
				</div>
				<pre data-id="code"><code class="language-java" data-trim >

						new Thread(() -> System.out.print("Counting")).start();

					</code></pre>
				<div class="text-4xl">
				</div>
			</section>

			<section data-auto-animate>
				<div data-id="text" class="text-3xl">Let's work a bit!</div>
				<pre data-id="code"><code class="language-java" data-trim >
				Runnable countAnimals = () -> 
					System.out.println("Counting all the animals in the zoo"); 
				
				Runnable printAnimalProfiles = () -> 
					IntStream.rangeClosed(1, 3).forEach(i -> 
						System.out.println("Printing profile of animal " + i)
					);
					</code></pre>
			</section>

			<section data-auto-animate>
				<div data-id="text" class="text-3xl">Let's work a bit!</div>
				<pre data-id="code"><code class="language-java" data-trim ="8-13">
				Runnable countAnimals = () -> 
					System.out.println("Counting all the animals in the zoo"); 
					
				Runnable printAnimalProfiles = () -> 
					IntStream.rangeClosed(1, 3).forEach(i -> 
						System.out.println("Printing profile of animal " + i)
					);

				System.out.println("Zoo day begins");  
				new Thread(countAnimals).start(); 
				new Thread(printAnimalProfiles).start(); 
				new Thread(countAnimals).start(); 
				System.out.println("Zoo day ends");
					</code></pre>
				<div class="text-3xl fragment fade-in">Overtime?</div>
			</section>

			<section>
				<div class="text-2xl">
					<ul>
						<li>Use Concurrency API</li>
					</ul>
					<p class="fragment fade-in italic">later!</p>
				</div>
			</section>

			<!-- Thread Types -->
			<section>
				<h4>There are more Threads!</h2>
			</section>

			<section>
				<h6>Thread Types</h2>
					<div class="flex text-2xl text-left">
						<div class="w-1/3">
							<p><strong>System Threads</strong></p>
							<ul>
								<li>Created by JVM</li>
								<li>Run in background</li>
								<li>Example: Garbage collection</li>
							</ul>
						</div>
						<div class="w-1/3">
							<p><strong>User-Defined Threads</strong></p>
							<ul>
								<li>Created by developers</li>
								<li>Specific tasks</li>
								<li>Example: `main()` method thread</li>
							</ul>
						</div>
						<div class="w-1/3">
							<p><strong>Daemon Threads</strong></p>
							<ul>
								<li>JVM exits if only daemon threads are running</li>
								<li>Example: Garbage collection</li>
							</ul>
						</div>
					</div>
			</section>

			<section data-auto-animate>
				<pre data-id="code"><code class="language-java" data-trim data-line-numbers>
								public class Zookeper {
									public static void main(String[] unused) {
										var feedingJob = new Thread(Zookeper::feedAnimals);
										feedingJob.start();
										System.out.println("Zoo is closing");
									}
							
									@SneakyThrows
									private static void feedAnimals() {
										Thread.sleep(3_000);
										System.out.println("All animals fed!");
									}
								}
								</code></pre>
			</section>

			<section data-auto-animate>
				<pre data-id="code"><code class="language-java" data-trim data-line-numbers>
								public class EvilZookeper {
									public static void main(String[] unused) {
										var feedingJob = new Thread(Zookeper::feedAnimals);
										feedingJob.setDaemon(true);
										feedingJob.start();
										System.out.println("Zoo is closing");
									}
							
									@SneakyThrows
									private static void feedAnimals() {
										Thread.sleep(3_000);
										System.out.println("All animals fed!");
									}
								}
								</code></pre>
			</section>

			<!-- Managing a Thread’s Life Cycle -->
			<section>
				<h3>Thread’s Life Cycle</h3>
			</section>

			<section>
				<!-- <div class="flex text-2xl text-left"> -->
				<div class="text-left">
					<p>State <code>enum</code> in <code>java.lang.Thread</code>:</p>
					<ul>
						<li><code>NEW</code></li>
						<li><code>RUNNABLE</code></li>
						<li><code>BLOCKED</code></li>
						<li><code>WAITING</code></li>
						<li><code>TIMED_WAITING</code></li>
						<li><code>TERMINATED</code></li>
					</ul>
				</div>
			</section>

			<section>
				<div class="-mx-40 -my-10">
					<img src="./media/d2plots/2_thread_states.svg" class="r-stretch" />
				</div>
			</section>


			<section>
				<h4>Let's wait for million visitors now!</h4>
			</section>

			<section>
				<h4>Concurrency API</h4>
			</section>

			<section>
				ExecutorService
				- java.util.concurrent interface for managing and scheduling the execution of tasks in a thread pool.
			</section>

			<section>
				<div class="-mx-40 -my-10">
					<img src="./media/d2plots/3_ExecutorService_file_cycle.svg" class="r-stretch" />
				</div>
			</section>

			<section>
				<h4>Concurrency API</h4>
			</section>

			<section>
				<div class="text-2xl text-left">
					<ul>
						<li><strong>Thread Pool:</strong> A collection of pre-initialized threads, reusable for executing tasks.
							Improves performance by reducing the overhead of thread creation and destruction.</li>
						<li><strong>ExecutorService:</strong> An interface for managing a thread pool. Provides methods for task
							scheduling and lifecycle management, like graceful shutdown.</li>
						<li><strong>Executors:</strong> Utility class in Java that provides factory methods for creating different
							types of Executor Services, such as single-threaded, fixed-size, and cached thread pools.</li>
					</ul>
					Executor Service manages a Thread Pool, and Executors make it easy to create and configure an Executor Service
				</div>
			</section>

			<!-- https://www.baeldung.com/thread-pool-java-and-guava -->

			<section data-auto-animate>
				<div class="text-3xl" data-id="text">Let's rewrite earlier example</div>
				<pre><code data-id="code" class="language-java" data-trim="">
						Runnable countAnimals = () -> {}; //omitted
						Runnable printAnimalProfiles = () -> {}; //omitted

						ExecutorService service = Executors.newSingleThreadExecutor()
						try {
							  System.out.println("Zoo day begins");
							  service.execute(countAnimals);
							  service.execute(printAnimalProfiles);
							  service.execute(countAnimals);
							  System.out.println("Zoo day ends");
						} finally {
							  service.shutdown();
						}
					</code></pre>
				<!-- Once you have finished using a thread executor, it is important that you call the shutdown() method. 
					A thread executor creates a non-daemon thread on the first task that is executed, so failing to call 
					shutdown() will result in your application never terminating. -->
			</section>
			</section>


			<section data-auto-animate>
				<div class="text-3xl" data-id="text">Or use try-with-resources</div>
				<pre><code data-id="code" class="language-java" data-trim="">
					Runnable countAnimals = () -> {}; //omitted
					Runnable printAnimalProfiles = () -> {}; //omitted

					try (ExecutorService service = 
											Executors.newSingleThreadExecutor()) {
						  System.out.println("Zoo day begins");
						  service.execute(countAnimals);
						  service.execute(printAnimalProfiles);
						  service.execute(countAnimals);
						  System.out.println("Zoo day ends");
					}
					</code></pre>
				<!-- AutoCloseable interface -->
			</section>



			<section>
				<div class="text-4xl font-semibold">ExecutorService life cycle</div>
				<div>
					<img src="./media/d2plots/3_ExecutorService_file_cycle.svg" class="r-stretch" />
				</div>
				<!-- be aware that shutdown() does not stop any tasks that have already been submitted to the thread executor -->
			</section>



			<section>
				<div>
					<div class="text-4xl" data-id="text">Meet the <code>Callable</code></div>
					<pre data-id="code" class="language-java"><code data-trim><script type="text/template">
					@FunctionalInterface
					public interface Callable<V> {
						V call() throws Exception;
					}
				</script></code></pre>
				</div>
			</section>


			<section>
				<div class="text-3xl" data-id="text">Executing tasks with <strong>ExecutorService</strong></div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim="" data-line-numbers="1-6|8-10|12-20"><script type="text/template">

							void execute(Runnable command)
							// Executes Runnable task at some point in future.
							
							Future<?> submit(Runnable task)
							// Executes Runnable task at some point in future 
							// and returns Future representing task.
							
							<T> Future<T> submit(Callable<T> task)
							// Executes Callable task at some point in future 
							// and returns Future representing pending results of task.
							
							<T> List<Future<T>> 
									    invokeAll(Collection<? extends Callable<T>> tasks)
							// Executes given tasks and waits for all tasks to 
							// complete. Returns List of Future instances in same 
							// order in which they were in original collection.
							
							<T> T invokeAny(Collection<? extends Callable<T>> tasks)
							// Executes given tasks and waits for at least one to 
							// complete.

						</script></code></pre>
				</div>
			</section>


			<section>
				<div class="text-3xl" data-id="text">Waiting for <strong>Future</strong> results</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim="" data-line-numbers="1-7|9-12|14-22"><script type="text/template">

						void isDone()
						// Returns true if task was completed, threw an exception, 
						// or was canceled.
						
						boolean isCancelled()
						// Returns true if the task was canceled before it 
						// completed normally.
						
						boolean cancel(boolean mayInterruptIfRunning)
						// Attempts to cancel the execution of the task and returns
						// true if it was successfully canceled or false if it 
						// could not be canceled or is complete.
						
						V get()
						// Retrieves the result of the task, waiting endlessly if 
						// it is not yet available.
						
						V get(long timeout, TimeUnit unit)
						// Retrieves the result of the task, waiting for the 
						// specified amount of time. If the result is not ready by 
						// the time the timeout is reached, a checked 
						// TimeoutException will be thrown.
						
						</script></code></pre>
				</div>
			</section>

			<section>
				<h4>Let's sell some tickets to zoo now!</h4>
			</section>


			<section>
				<h3>Scheduling Tasks</h3>
			</section>

			<section>
				<pre><code class="language-java" data-trim=""><script type="text/template">
					ScheduledExecutorService service
						= Executors.newSingleThreadScheduledExecutor();
				</script></code></pre>
				<div class="text-2xl text-left mx-20">
					<ul class="space-y-2">
						<li>Enables sheduling tasks</li>
						<li>Subinterface of <strong>ExecutorService</strong> </li>
						<li>All method return <strong>ScheduledFuture</strong> </li>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Scheduling tasks with <strong>ScheduledExecutorService</strong></div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="1-7|9-13|15-20"><script type="text/template">

						schedule(Callable<V> callable, long delay, TimeUnit unit)
						// Creates and executes a Callable task after the given 
						// delay.
						
						schedule(Runnable command, long delay, TimeUnit unit)
						// Creates and executes a Runnable task after the given
						// delay.
						
						scheduleAtFixedRate(Runnable command, long initialDelay, 
																long period, TimeUnit unit)
						// Creates and executes a Runnable task after the given 
						// initial delay, creating a new task every period value 
						// that passes.
						
						scheduleWithFixedDelay(Runnable command, long initialDelay, 
																	 long delay, TimeUnit unit)
						// Creates and executes a Runnable task after the given 
						// initial delay and subsequently with the given delay 
						// between the termination of one execution and the 
						// beginning of the next.
						</script></code></pre>
				</div>
				<!-- These methods are among the most convenient in the Concurrency API, as they perform relatively complex tasks with a single line of code. -->

			</section>

			<section>
				<img src="./media/ScheduledExecutorService.jpg" class="r-stretch" />
			</section>

			<section>
				<h4>Okay, but where is concurrency?</h4>
			</section>

			<section>
				<h3>Thread Pools</h3>
			</section>

			<section>
				<div class="text-3xl" data-id="text"><strong>Executors</strong> factory methods</div>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="|5-8|10-16"><script type="text/template">

						ExecutorService newSingleThreadExecutor()

						ScheduledExecutorService newSingleThreadScheduledExecutor()
						
						ExecutorService newCachedThreadPool()
						// Creates a thread pool that creates new threads as needed
						// but reuses previously constructed threads when they are 
						// available.
						
						ExecutorService newFixedThreadPool(int nThreads)
						// Creates a thread pool that reuses a fixed number of 
						// threads operating off a shared unbounded queue.
						
						ScheduledExecutorService newScheduledThreadPool(
																											int nThreads)
						// Creates a thread pool that can schedule commands to 
						// run after a given delay or execute periodically.
					</script></code></pre>
				</div>
				<!-- there is no hard limit to the number of threads it can spawn; it will keep creating new threads as long as tasks keep getting submitted and existing threads are occupied. However, unused threads will be terminated and removed from the cache if they remain idle for 60 seconds. -->
			</section>

			<section>
				<h2>Thread safety</h2>
			</section>

			<section>
				<div>
					<pre><code data-id="code" class="language-java" data-trim data-line-numbers="|2|4-6|8-18"><script type="text/template">
						public class MonkeyKeeper {
							private static int monkeyCount;
					
							private static void incrementAndReport() {
								System.out.print(++monkeyCount + " ");
							}
						
							public static void main(String[] args) {
								try (ExecutorService service =
																	Executors.newFixedThreadPool(10)) {
									IntStream
										.range(0, 10)
										.forEach(i -> service.submit(
																		MonkeyKeeper::incrementAndReport));
								}
							}
						}
					
					</script></code></pre>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">possible outcomes</div>
				<div class="flex justify-center">
					<div class="w-2/5">
						<pre><code data-id="code" class="language-java" data-trim ><script type="text/template">
						1 2 3 4 5 6 7 8 9 10 
						1 8 7 3 2 6 5 4 10 9
						1 9 8 7 3 6 6 2 4 5
					</script></code></pre>
					</div>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">What happened there?</div>
				<div class="flex justify-center">
					<img src="./media/lack-of-synchronization.drawio.svg" class="w-4/6" />
				</div>
			</section>

			<!-- https://www.geeksforgeeks.org/volatile-keyword-in-java/ -->

			<section>
				<div class="space-y-4">
					<div class="text-2xl">Also... </div>
					<div class="text-3xl">Changes made to static <code>monkeyCount</code> in one thread </div>
					<div class="text-3xl">may not immediately be visible to another thread</div>
					<div class="text-3xl fragment fade-in">How to ensure its visibility?</div>
				</div>
			</section>

			<section>
				<div class="text-3xl my-5" data-id="text"><strong>volatile</strong> keyword</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class MonkeyKeeper {
						private volatile static int monkeyCount;
						//...
					}
				</script></code></pre>
				<div class="text-3xl fragment fade-in">This won't work...</div>
				<!-- https://www.geeksforgeeks.org/volatile-keyword-in-java/ -->
			</section>

			<section>
				<div class="text-3xl my-5" data-id="text"><code>volatile</code> provides:</div>
				<div class="flex justify-center">
					<div class="text-2xl text-left w-2/3">
						<div class="">1. <strong>Visibility</strong>: Every read of that field is read directly from the main
							memory.
						</div>
						<div class="">2. <strong>Ordering</strong>: Every write to the field will be written/flushed directly to the
							main memory ("happens-before" relationship)</div>
					</div>
				</div>
			</section>

			<section>
				<div class="text-3xl" data-id="text">typical <code>volatile</code> usage</div>

				<pre><code class="language-java" data-trim ><script type="text/template">
					public class SharedResource {
						private volatile boolean flag = false;
				
						public void turnOn() {
								flag = true;
						}
				
						public void checkStatus() {
								if (flag) {
										// Do something...
								}
						}
					}
				</script></code></pre>
				<div class="text-xl">
					<div class="fragment fade-in">One thread is calling the <code>turnOn()</code> method and another thread
						is calling <code>checkStatus()</code>
					</div>
					<div class="fragment fade-in">The second thread is guaranteed to see the updated value of <code>flag</code> if
						it checks after the first thread has called <code>turnOn()</code>.
					</div>
			</section>


			<section>
				<div class="space-y-4">
					<div class="text-2xl">Let's come back to the monkeys</div>
					<div class="text-4xl fragment fade-in">How to fix it?</div>
				</div>
			</section>

			<!--  SYNCHRONIZATION -->
			<section>
				<h3>Synchronization</h3>
			</section>

			<!--  ATOMIC CLASSES -->
			<section>
				<h3>Atomic classes</h3>
			</section>


			<section>
				<ul class="text-2xl space-y-4">
					<li><strong>Atomic</strong> is the property of an operation to be carried out as a single unit of execution
						without any interference from another thread</li>
					<li>Atomic classes provide a way to perform atomic operations on a single variable without using synchronized
						blocks.</li>
					<li>Part of the <code>java.util.concurrent.atomic</code></li>
				</ul>
			</section>

			<section>
				<div class="text-3xl" data-id="text">Atomic operations</div>
				<div class="flex justify-center">
					<img src="./media/atomic-operation.drawio.svg" class="w-4/6" />
				</div>
			</section>

			<section>
				<pre><code class="language-java" data-trim ><script type="text/template">
					public class MonkeyKeeper {
						private AtomicInteger monkeyCount = new AtomicInteger(0)

						private void incrementAndReport() {
							System.out.print(monkeyCount.incrementAndGet()+" ");
						}
						//...
					}
				</script></code></pre>
			</section>

			<section>
				<div class="text-2xl">Other atomic classes</div>
				<pre><code class="language-java" data-trim ><script type="text/template">
					AtomicInteger counter = new AtomicInteger(0);

					AtomicLong counter = new AtomicLong(0L);

					AtomicBoolean flag = new AtomicBoolean(false);
					
					AtomicReference<String> string = new AtomicReference<>("");
	
				</script></code></pre>
				<div class="fragment fade-in">
					<div class="text-xl my-5">+ array versions:</div>
					<pre><code class="language-java" data-trim >
				AtomicIntegerArray, AtomicLongArray, AtomicReferenceArray
				</code></pre>
				</div>
			</section>


	<section>
		<div class="text-3xl" data-id="text"><strong>Common atomic methods</div>
		<div>
			<pre><code data-id="code" class="language-java" data-trim data-line-numbers="1-9|11-22"><script type="text/template">
				get()
				// Retrieves the current value.

				set(type newValue)
				// Sets the given value, 

				getAndSet(type newValue)
				//  sets a new value and returns the old value

				// For numeric classes only:
				incrementAndGet()
				// equivalent to ++value

				getAndIncrement()
				// equivalent to value++

				decrementAndGet()
				// equivalent to --value

				getAndDecrement()
				// equivalent to value--
			</script></code></pre>
		</div>
	</section>

	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes],

			margin: 0.15,
			minScale: 0.2,
			maxScale: 2.0
		});
	</script>
</body>

</html>